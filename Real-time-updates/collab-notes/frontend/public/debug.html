<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .log { margin: 5px 0; padding: 5px; background: #f0f0f0; }
        .error { background: #ffcccc; }
        .success { background: #ccffcc; }
    </style>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    <div>
        <label>Document ID: <input type="text" id="docId" value="test-doc-123" /></label>
        <label>User ID: <input type="text" id="userId" value="test-user-1" /></label>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
    </div>
    <div>
        <label>Message: <input type="text" id="message" value="Hello" /></label>
        <button onclick="sendInsert()">Send INSERT</button>
    </div>
    <div id="logs"></div>

    <script>
        let ws = null;

        function log(message, type = 'log') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            document.getElementById('logs').appendChild(div);
        }

        function connect() {
            const docId = document.getElementById('docId').value;
            const userId = document.getElementById('userId').value;
            const url = `ws://localhost:8081/api/ws?documentId=${docId}&userId=${userId}`;
            
            log('Connecting to: ' + url);
            
            ws = new WebSocket(url);
            
            ws.onopen = () => {
                log('âœ… Connected!', 'success');
            };
            
            ws.onmessage = (event) => {
                log('ðŸ“¨ Received: ' + event.data, 'success');
                try {
                    const msg = JSON.parse(event.data);
                    log('Parsed: ' + JSON.stringify(msg, null, 2));
                } catch (e) {
                    log('Parse error: ' + e.message, 'error');
                }
            };
            
            ws.onerror = (error) => {
                log('âŒ Error: ' + error, 'error');
            };
            
            ws.onclose = () => {
                log('Connection closed');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function sendInsert() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Not connected!', 'error');
                return;
            }
            
            const docId = document.getElementById('docId').value;
            const userId = document.getElementById('userId').value;
            const text = document.getElementById('message').value;
            
            const operation = {
                type: "OPERATION",
                operation: {
                    type: "INSERT",
                    position: 0,
                    text: text,
                    documentId: docId,
                    userId: userId,
                    timestamp: Date.now()
                }
            };
            
            log('ðŸ“¤ Sending: ' + JSON.stringify(operation));
            ws.send(JSON.stringify(operation));
        }
    </script>
</body>
</html>
